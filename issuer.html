<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>印绩企业端管理系统</title>
    <style>
        /* 全局样式 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: #fff; }
        h1, h2, h3 { color: #2c3e50; margin-bottom: 15px; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        input[type="text"], input[type="password"], input[type="date"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        input:focus, textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 4px; }
        .alert-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        /* 顶部导航 */
        .header { background-color: #2c3e50; color: white; padding: 15px 0; margin-bottom: 20px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { color: white; margin: 0; font-size: 24px; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions button { background-color: transparent; border: 1px solid white; color: white; }
        .header-actions button:hover { background-color: white; color: #2c3e50; }
        
        /* 导航标签页 */
        .nav-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; background-color: #fff; border-radius: 4px 4px 0 0; overflow-x: auto; }
        .nav-tab { padding: 12px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: #f8f9fa; border-top-left-radius: 4px; border-top-right-radius: 4px; margin-right: 2px; white-space: nowrap; transition: all 0.3s; }
        .nav-tab:hover { background-color: #e9ecef; }
        .nav-tab.active { background: white; border-color: #ddd; color: #3498db; font-weight: bold; }
        
        /* 标签页内容 */
        .tab-content { display: none; background-color: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; padding: 20px; }
        .tab-content.active { display: block; }
        
        /* 表格样式 */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        tr:hover { background-color: #f5f5f5; }
        
        /* 按钮样式 */
        .btn-danger { background-color: #e74c3c; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: #95a5a6; }
        .btn-secondary:hover { background-color: #7f8c8d; }
        .btn-success { background-color: #2ecc71; }
        .btn-success:hover { background-color: #27ae60; }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-warning { background-color: #f39c12; color: white; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer; }
        .btn-warning:hover { background-color: #e67e22; }
        
        /* 统计卡片样式 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h4 { margin-top: 0; color: #666; font-size: 14px; font-weight: normal; }
        .stat-card p { font-size: 32px; font-weight: bold; color: #3498db; margin: 10px 0 0; }
        
        /* 验证器样式 */
        .verification-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .verification-method { flex: 1; min-width: 250px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        #qr-scan-area { width: 100%; height: 250px; background-color: #f9f9f9; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin: 10px 0; }
        #qr-scan-area p { color: #666; text-align: center; }
        .verification-result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .result-header { font-weight: bold; margin-bottom: 10px; }
        .result-details { margin-left: 15px; }
        
        /* 状态样式 */
        .status-active { color: #27ae60; font-weight: bold; }
        .status-inactive { color: #e74c3c; font-weight: bold; }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 10px; }
            .header h1 { font-size: 20px; }
            .nav-tabs { justify-content: flex-start; }
            .verification-container { flex-direction: column; }
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <!-- 仪表盘容器 -->
    <div id="dashboard-container">
        <!-- 顶部导航 -->
        <div class="header">
            <div class="container header-content">
                <div class="header-left">
                    <h1>印绩企业端管理系统</h1>
                </div>
                <div class="header-actions">
                    <button id="settings-btn">系统设置</button>
                    <button id="logout-btn" class="btn-danger">退出登录</button>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- 导航标签页 -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="dashboard">概览</div>
                <div class="nav-tab" data-tab="issue">发行凭证</div>
                <div class="nav-tab" data-tab="manage">管理凭证</div>
                <div class="nav-tab" data-tab="verifier">凭证验证</div>
            </div>
            
            <!-- 概览面板 -->
            <div id="dashboard-content" class="tab-content active">
                <h2>系统概览</h2>
                <div class="card">
                    <p><strong>已发行凭证总数：</strong><span id="total-credentials">0</span></p>
                    <p><strong>今日发行：</strong><span id="today-credentials">0</span></p>
                    <p><strong>待验证：</strong><span id="pending-credentials">0</span></p>
                    <p><strong>已验证：</strong><span id="verified-credentials">0</span></p>
                </div>
            </div>
            
            <!-- 发行凭证面板 -->
            <div id="issue-content" class="tab-content">
                <h2>发行新凭证</h2>
                <div class="card">
                    <div id="issue-message" class="alert" style="display: none;"></div>
                    <div class="form-group">
                        <label for="employee-name">员工姓名</label>
                        <input type="text" id="employee-name" placeholder="请输入员工姓名">
                    </div>
                    <div class="form-group">
                        <label for="job-title">职位</label>
                        <input type="text" id="job-title" placeholder="请输入职位名称">
                    </div>
                    <div class="form-group">
                        <label for="start-date">入职日期</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="form-group">
                        <label for="end-date">离职日期（如适用）</label>
                        <input type="date" id="end-date" placeholder="留空表示在职">
                    </div>
                    <div class="form-group">
                        <label for="description">备注说明</label>
                        <textarea id="description" rows="3" placeholder="可选的备注信息"></textarea>
                    </div>
                    <button id="issue-btn">生成凭证</button>
                </div>
            </div>
            
            <!-- 管理凭证面板 -->
            <div id="manage-content" class="tab-content">
                <h2>凭证管理</h2>
                <div class="card">
                    <div id="manage-message" class="alert" style="display: none;"></div>
                    <div class="form-group">
                        <input type="text" id="search-credentials" placeholder="搜索凭证（姓名、验证码）">
                    </div>
                    <table id="credentials-table">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>职位</th>
                                <th>入职日期</th>
                                <th>离职日期</th>
                                <th>验证码</th>
                                <th>验证状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center;">暂无凭证数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 凭证验证面板 -->
            <div id="verifier-content" class="tab-content">
                <h2>凭证验证</h2>
                <div class="card">
                    <div id="verification-message" class="alert" style="display: none;"></div>
                    
                    <div class="verification-container">
                        <!-- 输入验证码验证 -->
                        <div class="verification-method">
                            <h3>输入验证码验证</h3>
                            <div class="form-group">
                                <input type="text" id="verification-code" placeholder="请输入8位验证码">
                            </div>
                            <button id="verify-btn">验证</button>
                        </div>
                        
                        <!-- 扫码验证 -->
                        <div class="verification-method">
                            <h3>扫码验证</h3>
                            <button id="start-scan-btn" class="btn-success">开始扫码</button>
                            <div id="qr-scan-area">
                                <video id="qr-video" style="display: none; width: 100%; max-width: 300px; margin: 0 auto;" autoplay></video>
                                <p id="scan-instruction">请点击上方的"开始扫码"按钮</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 验证结果 -->
                    <div id="verification-result" class="verification-result" style="display: none;">
                        <div class="result-header">验证结果</div>
                        <div class="result-details">
                            <p><strong>验证状态：</strong><span id="result-status"></span></p>
                            <p><strong>员工姓名：</strong><span id="result-name"></span></p>
                            <p><strong>职位：</strong><span id="result-title"></span></p>
                            <p><strong>入职日期：</strong><span id="result-start-date"></span></p>
                            <p><strong>离职日期：</strong><span id="result-end-date"></span></p>
                            <p><strong>所属公司：</strong><span id="result-company"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 设置模态框 -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h2>系统设置</h2>
            <div id="settings-message" class="alert" style="display: none;"></div>
            <div class="form-group">
                <label for="company-name">公司名称</label>
                <input type="text" id="company-name" placeholder="请输入公司名称">
            </div>
            <div class="form-group">
                <label for="company-website">公司网站</label>
                <input type="text" id="company-website" placeholder="请输入公司网站">
            </div>
            <div class="form-group">
                <label for="contact-email">联系邮箱</label>
                <input type="text" id="contact-email" placeholder="请输入联系邮箱">
            </div>
            <div class="form-group">
                <label for="max-verifications">最大验证次数</label>
                <input type="number" id="max-verifications" placeholder="默认为5次">
            </div>
            <div class="form-group">
                <label for="verification-window">验证有效期（天）</label>
                <input type="number" id="verification-window" placeholder="默认为30天">
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="enable-notifications"> 启用验证通知</label>
            </div>
            <button id="save-settings-btn">保存设置</button>
            <button id="change-password-btn" class="btn-secondary">修改密码</button>
            <button id="close-settings-btn" class="btn-secondary">关闭</button>
        </div>
    </div>
    
    <!-- 凭证生成成功模态框 -->
    <div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 400px; width: 90%; text-align: center;">
            <h2>凭证生成成功</h2>
            <p id="success-message" style="font-size: 18px; margin: 20px 0;"></p>
            <div id="success-qr-code" style="margin: 20px auto;"></div>
            <button id="success-close-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    
    <!-- 凭证详情模态框 -->
    <div id="credential-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h2>凭证详情</h2>
            <div id="detail-content" style="margin: 20px 0;">
                <p><strong>验证码：</strong><span id="detail-verification-code" style="font-family: monospace; font-size: 18px; color: #3498db;"></span></p>
                <div id="detail-qr-code" style="margin: 20px auto; text-align: center;"></div>
                <div id="detail-info" style="margin-top: 20px;"></div>
            </div>
            <button id="detail-close-btn" style="margin-top: 20px;">关闭</button>
        </div>
    </div>

    <script>
        // API基础URL - 使用相对路径，支持任何部署环境
        const API_BASE_URL = '/api';
        
        // 全局凭证存储，用于在前端管理凭证数据
        let credentialsStore = [
            {
                employee_name: "张三",
                job_title: "软件工程师",
                employment_start_date: "2022-01-15",
                employment_end_date: null,
                verification_code: "ABC12345",
                verified: true,
                company_name: "示例企业"
            },
            {
                employee_name: "李四",
                job_title: "产品经理",
                employment_start_date: "2022-03-20",
                employment_end_date: "2023-06-10",
                verification_code: "DEF67890",
                verified: true,
                company_name: "示例企业"
            },
            {
                employee_name: "王五",
                job_title: "UI设计师",
                employment_start_date: "2022-05-01",
                employment_end_date: null,
                verification_code: "GHI78901",
                verified: false,
                company_name: "示例企业"
            }
        ];
        
        // 模拟用户数据
        const mockUsers = [
            { username: "admin", role: "管理员", status: "启用" },
            { username: "manager", role: "经理", status: "启用" },
            { username: "hr", role: "人事", status: "禁用" }
        ];
        
        // API请求包装函数（优先使用模拟数据，确保页面可用性）
        async function apiRequest(endpoint, method = 'GET', data = null) {
            // 优先使用模拟数据，避免对后端API的依赖
            const useMockData = true;
            
            if (useMockData) {
                // 根据请求端点返回相应的模拟数据
                if (endpoint === '/api/credentials' && method === 'GET') {
                    return credentialsStore;
                } else if (endpoint === '/api/credentials' && method === 'POST') {
                    const verificationCode = generateVerificationCode();
                    
                    const newCredential = {
                        employee_name: data.employeeName,
                        job_title: data.jobTitle,
                        employment_start_date: data.startDate,
                        employment_end_date: data.endDate || null,
                        verification_code: verificationCode,
                        verified: false,
                        company_name: currentIssuer.companyName || "示例企业"
                    };
                    
                    credentialsStore.unshift(newCredential);
                    
                    return { success: true, verificationCode: verificationCode };
                } else if (endpoint.startsWith('/api/verify/') && method === 'GET') {
                    const code = endpoint.split('/').pop();
                    const credential = credentialsStore.find(c => c.verification_code === code);
                    
                    return { valid: !!credential, ...credential };
                } else if (endpoint === '/api/verify' && method === 'POST') {
                    const code = data.code;
                    const credential = credentialsStore.find(c => c.verification_code === code);
                    
                    if (credential) {
                        credential.verified = true;
                    }
                    
                    return { valid: !!credential, ...credential };
                } else if (endpoint.startsWith('/api/credentials/verify/') && method === 'GET') {
                    const code = endpoint.split('/').pop();
                    const credential = credentialsStore.find(c => c.verification_code === code);
                    
                    if (credential) {
                        credential.verified = true;
                    }
                    
                    return { valid: !!credential, ...credential };
                } else if (endpoint === '/api/settings' && method === 'PUT') {
                    return { success: true };
                }
                return { success: true };
            }
            
            // 实际API调用（当前不会执行）
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NjE5NjM3NjQsImlhdCI6MTcxNTk2Mzc2NCwiaXNzIjoiVHJ1ZU1hcmsiLCJzdWIiOiJ7XCJjb21wYW55SWQ6XCJleGFtcGxlLWNvbXBhbnlcIn0ifQ.HQpUxWz2t4Y3a4M9452bUfKZ9Yv4nP8Gp45mJ3h8k2E'
            };
            
            try {
                const options = { method, headers };
                if (data) options.body = JSON.stringify(data);
                
                const response = await fetch(url, options);
                if (!response.ok) {
                    return { success: false, message: `API请求失败: ${response.status}` };
                }
                return await response.json();
            } catch (error) {
                console.error('API请求错误:', error);
                return { success: false, message: error.message };
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化功能...');
            // 检查认证状态
            checkAuthStatus();
            // 设置退出登录功能
            setupLogout();
            // 设置其他页面功能
            setupTabNavigation();
            setupCredentialSearch();
            loadDashboardData();
            loadCredentials();
        });
        
        // 获取页面元素
        const dashboardContainer = document.getElementById('dashboard-container');
        const issueMessage = document.getElementById('issue-message');
        const manageMessage = document.getElementById('manage-message');
        const settingsMessage = document.getElementById('settings-message');
        const verificationMessage = document.getElementById('verification-message');
        const settingsModal = document.getElementById('settings-modal');
        
        // 模拟当前登录的发行方信息
        let currentIssuer = {
            companyName: "示例企业",
            companyWebsite: "https://example.com",
            contactEmail: "contact@example.com"
        };
        
        // 显示消息
        function showMessage(element, message, type) {
            element.innerHTML = message;
            element.className = 'alert alert-' + type;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // 切换标签页
        function setupTabNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有激活状态
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // 添加当前标签激活状态
                    this.classList.add('active');
                    const tabId = this.dataset.tab;
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // 切换标签页时检查并停止扫描
                    const verifyBtn = document.getElementById('start-scan-btn');
                    if (verifyBtn && verifyBtn.textContent === '停止扫码') {
                        verifyBtn.click();
                    }
                });
            });
        }
        
        // 加载仪表盘数据
        function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0];
            
            // 模拟仪表盘数据
            const total = credentialsStore.length;
            const todayCount = 3; // 模拟今日发行3个
            const pending = credentialsStore.filter(c => !c.verified).length;
            const verified = credentialsStore.filter(c => c.verified).length;
            
            // 更新仪表盘数据
            document.getElementById('total-credentials').textContent = total;
            document.getElementById('today-credentials').textContent = todayCount;
            document.getElementById('pending-credentials').textContent = pending;
            document.getElementById('verified-credentials').textContent = verified;
        }
        
        // 生成验证码
        function generateVerificationCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // 退出登录
        function setupLogout() {
            document.getElementById('logout-btn').addEventListener('click', function() {
                if (confirm('确定要退出登录吗？')) {
                    // 全面清除认证相关数据
                    // 清除localStorage中的认证信息
                    localStorage.removeItem('token');
                    localStorage.removeItem('userInfo');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('accessToken');
                    
                    // 清除sessionStorage中的认证信息
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('userInfo');
                    sessionStorage.removeItem('authToken');
                    sessionStorage.removeItem('accessToken');
                    
                    // 清除可能存在的cookies
                    document.cookie.split(";").forEach(function(c) {
                        document.cookie = c.replace(/^\s+/, "").replace(/=.*/, "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/");
                    });
                    
                    // 简化重定向逻辑，确保正确跳转到登录页
                    console.log('正在退出登录，清除所有认证信息');
                    // 不使用alert，直接执行跳转以避免用户体验问题
                    setTimeout(function() {
                        // 使用assign确保直接加载新页面
                        window.location.assign('/index.html');
                    }, 50);
                }
            });
        }
        
        // 页面加载时检查认证状态
        function checkAuthStatus() {
            // 注意：当前代码使用模拟数据，无需真实认证
            // 但为了完整性，添加此函数以便将来扩展
            console.log('检查认证状态...');
        }
        
        // 搜索凭证
        function setupCredentialSearch() {
            document.getElementById('search-credentials').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredCredentials = credentialsStore.filter(cred => 
                    cred.employee_name.toLowerCase().includes(searchTerm) ||
                    cred.verification_code.toLowerCase().includes(searchTerm)
                );
                
                displayCredentials(filteredCredentials);
            });
        }
        
        // 显示凭证列表
        function displayCredentials(credentials) {
            const tableBody = document.getElementById('credentials-table').querySelector('tbody');
            
            if (credentials.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无凭证数据</td></tr>';
                return;
            }
            
            const html = credentials.map(cred => `
                <tr>
                    <td>${cred.employee_name}</td>
                    <td>${cred.job_title}</td>
                    <td>${cred.employment_start_date}</td>
                    <td>${cred.employment_end_date || '至今'}</td>
                    <td>${cred.verification_code}</td>
                    <td class="${cred.verified ? 'status-active' : 'status-inactive'}">${cred.verified ? '已验证' : '未验证'}</td>
                    <td>
                        <button onclick="viewCredential('${cred.verification_code}')">查看</button>
                        <button class="btn-danger" onclick="deleteCredential('${cred.verification_code}')">删除</button>
                    </td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = html;
        }
        
        // 加载凭证列表
        async function loadCredentials() {
            try {
                const credentials = await apiRequest('/api/credentials', 'GET');
                displayCredentials(credentials);
            } catch (error) {
                console.error('加载凭证失败:', error);
                // 使用模拟数据
                displayCredentials(credentialsStore);
            }
        }
        
        // 切换用户状态（全局函数）
        window.toggleUserStatus = function(username) {
            const user = mockUsers.find(u => u.username === username);
            if (user) {
                user.status = user.status === '启用' ? '禁用' : '启用';
                loadUsers();
            }
        };
        
        // 加载验证次数配置
        function loadVerificationSettings() {
            const savedSettings = localStorage.getItem('verificationSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    document.getElementById('max-verifications').value = settings.maxVerifications;
                    document.getElementById('verification-window').value = settings.verificationWindow;
                    document.getElementById('enable-notifications').checked = settings.enableNotifications;
                } catch (err) {
                    console.error('解析设置失败:', err);
                }
            }
        }
        
        // 查看凭证（全局函数）
        window.viewCredential = function(verificationCode) {
            const modal = document.getElementById('credential-detail-modal');
            const codeElement = document.getElementById('detail-verification-code');
            const qrCodeElement = document.getElementById('detail-qr-code');
            const infoElement = document.getElementById('detail-info');
            
            // 显示验证码
            codeElement.textContent = verificationCode;
            
            // 模拟二维码显示
            qrCodeElement.innerHTML = `<div style="padding: 20px; background: white; border: 1px solid #ddd; display: inline-block;">二维码图片</div>`;
            
            // 查找凭证信息
            const credential = credentialsStore.find(c => c.verification_code === verificationCode);
            
            if (credential) {
                infoElement.innerHTML = `
                    <p><strong>员工姓名：</strong>${credential.employee_name}</p>
                    <p><strong>职位：</strong>${credential.job_title}</p>
                    <p><strong>入职日期：</strong>${credential.employment_start_date}</p>
                    <p><strong>离职日期：</strong>${credential.employment_end_date || '至今'}</p>
                    <p><strong>所属公司：</strong>${credential.company_name}</p>
                    <p><strong>验证状态：</strong><span class="${credential.verified ? 'status-active' : 'status-inactive'}">${credential.verified ? '已验证' : '未验证'}</span></p>
                `;
            }
            
            // 显示模态框
            modal.style.display = 'flex';
        };
        
        // 删除凭证（全局函数）
        window.deleteCredential = function(verificationCode) {
            if (confirm('确定要删除这个凭证吗？')) {
                // 从全局存储中删除
                const index = credentialsStore.findIndex(c => c.verification_code === verificationCode);
                if (index !== -1) {
                    credentialsStore.splice(index, 1);
                    loadCredentials();
                    showMessage(manageMessage, '凭证删除成功', 'success');
                }
            }
        };
        
        // 加载用户列表
        function loadUsers() {
            // 实际应用中应该从API获取
            const userTableBody = document.querySelector('#users-table tbody');
            if (!userTableBody) return;
            
            const html = mockUsers.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${user.status}</td>
                    <td>
                        <button class="${user.status === '启用' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus('${user.username}')">
                            ${user.status === '启用' ? '禁用' : '启用'}
                        </button>
                    </td>
                </tr>
            `).join('');
            
            userTableBody.innerHTML = html;
        }
        
        // 加载设置
        function loadSettings() {
            document.getElementById('company-name').value = currentIssuer.companyName;
            document.getElementById('company-website').value = currentIssuer.companyWebsite;
            document.getElementById('contact-email').value = currentIssuer.contactEmail;
        }
        
        // 验证凭证功能
        function setupCredentialVerification() {
            document.getElementById('verify-btn').addEventListener('click', async function() {
                const verificationCode = document.getElementById('verification-code').value.trim();
                
                if (!verificationCode) {
                    showMessage(verificationMessage, '请输入验证码', 'error');
                    return;
                }
                
                try {
                    // 尝试使用多个端点进行验证
                    let result;
                    
                    // 优先使用POST端点
                    result = await apiRequest('/api/verify', 'POST', { code: verificationCode });
                    
                    console.log('验证结果:', result);
                    
                    if (result.valid) {
                        // 显示验证结果
                        const resultContainer = document.getElementById('verification-result');
                        
                        // 确保验证结果容器存在
                        if (!resultContainer) {
                            const card = this.closest('.card');
                            const newResultContainer = document.createElement('div');
                            newResultContainer.id = 'verification-result';
                            newResultContainer.className = 'verification-result';
                            newResultContainer.innerHTML = `
                                <div class="result-header">验证结果：<span id="result-status">有效</span></div>
                                <div class="result-details">
                                    <p><strong>员工姓名：</strong><span id="result-name">未知</span></p>
                                    <p><strong>职位：</strong><span id="result-title">未知</span></p>
                                    <p><strong>入职日期：</strong><span id="result-start-date">未知</span></p>
                                    <p><strong>离职日期：</strong><span id="result-end-date">至今</span></p>
                                    <p><strong>所属企业：</strong><span id="result-company">未知</span></p>
                                </div>
                            `;
                            card.appendChild(newResultContainer);
                        }
                        
                        // 更新验证结果
                        document.getElementById('result-status').textContent = '有效';
                        document.getElementById('result-status').style.color = '#27ae60';
                        document.getElementById('result-name').textContent = result.employee_name || '未知';
                        document.getElementById('result-title').textContent = result.job_title || '未知';
                        document.getElementById('result-start-date').textContent = result.employment_start_date || '未知';
                        document.getElementById('result-end-date').textContent = result.employment_end_date || '至今';
                        document.getElementById('result-company').textContent = result.company_name || '未知';
                        
                        document.getElementById('verification-result').style.display = 'block';
                        showMessage(verificationMessage, '验证成功', 'success');
                    } else {
                        showMessage(verificationMessage, '无效的验证码', 'error');
                        const resultContainer = document.getElementById('verification-result');
                        if (resultContainer) {
                            resultContainer.style.display = 'none';
                        }
                    }
                    
                } catch (err) {
                    console.error('验证凭证错误:', err);
                    showMessage(verificationMessage, '验证失败：请重试', 'error');
                    const resultContainer = document.getElementById('verification-result');
                    if (resultContainer) {
                        resultContainer.style.display = 'none';
                    }
                }
            });
        }
        
        // 扫码验证功能
        function setupQRScanner() {
            let scannerActive = false;
            let scanStream = null;
            let scanInterval = null;
            
            // 开始扫码按钮事件
            document.getElementById('start-scan-btn').addEventListener('click', function() {
                if (!scannerActive) {
                    startScanner();
                } else {
                    stopScanner();
                }
            });
            
            // 开始扫描功能
            function startScanner() {
                try {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        let video = document.getElementById('qr-video');
                        let instruction = document.getElementById('scan-instruction');
                        let scanArea = document.getElementById('qr-scan-area');
                        
                        if (!scanArea) {
                            console.error('找不到扫码区域元素');
                            showMessage(verificationMessage, '页面元素缺失，无法启动扫码', 'error');
                            return;
                        }
                        
                        // 创建必要的DOM元素
                        if (!video) {
                            video = document.createElement('video');
                            video.id = 'qr-video';
                            video.style.width = '100%';
                            video.style.height = '100%';
                            video.autoplay = true;
                            video.style.display = 'none';
                            scanArea.appendChild(video);
                        }
                        
                        if (!instruction) {
                            instruction = document.createElement('div');
                            instruction.id = 'scan-instruction';
                            instruction.textContent = '点击开始扫码按钮启动摄像头';
                            instruction.style.textAlign = 'center';
                            instruction.style.padding = '20px';
                            instruction.style.color = '#666';
                            scanArea.appendChild(instruction);
                        }
                        
                        video.style.display = 'block';
                        instruction.style.display = 'none';
                        
                        // 摄像头配置
                        const constraints = {
                            video: {
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };
                        
                        navigator.mediaDevices.getUserMedia(constraints)
                            .then(function(stream) {
                                scanStream = stream;
                                video.srcObject = stream;
                                scannerActive = true;
                                
                                // 更新按钮状态
                                const startScanBtn = document.getElementById('start-scan-btn');
                                if (startScanBtn) {
                                    startScanBtn.textContent = '停止扫码';
                                    startScanBtn.classList.remove('btn-success');
                                    startScanBtn.classList.add('btn-danger');
                                }
                                
                                showMessage(verificationMessage, '扫码器已启动，请将二维码对准摄像头', 'success');
                                
                                // 模拟扫码检测
                                let scanCounter = 0;
                                scanInterval = setInterval(async function() {
                                    scanCounter++;
                                    if (scanCounter % 10 === 0) {
                                        // 生成测试验证码
                                        const mockVerificationCode = 'TEST' + Math.floor(Math.random() * 1000000).toString().padStart(4, '0');
                                        console.log('模拟检测到二维码:', mockVerificationCode);
                                        
                                        // 填充并验证
                                        const verificationInput = document.getElementById('verification-code');
                                        if (verificationInput) {
                                            verificationInput.value = mockVerificationCode;
                                        }
                                        
                                        clearInterval(scanInterval);
                                        
                                        setTimeout(() => {
                                            const verifyBtn = document.getElementById('verify-btn');
                                            if (verifyBtn) {
                                                verifyBtn.click();
                                            }
                                        }, 500);
                                    }
                                }, 1000);
                            })
                            .catch(function(err) {
                                console.error('访问摄像头失败:', err);
                                
                                let errorMessage = '无法访问摄像头，请确保已授予权限';
                                if (err.name === 'NotAllowedError') {
                                    errorMessage = '摄像头访问被拒绝，请在浏览器设置中允许访问';
                                } else if (err.name === 'NotFoundError') {
                                    errorMessage = '未找到可用的摄像头';
                                } else if (err.name === 'NotReadableError') {
                                    errorMessage = '摄像头被其他应用占用，请关闭后重试';
                                }
                                
                                showMessage(verificationMessage, errorMessage, 'error');
                                
                                if (video) video.style.display = 'none';
                                if (instruction) instruction.style.display = 'block';
                            });
                    } else {
                        showMessage(verificationMessage, '您的浏览器不支持摄像头访问，请使用现代浏览器', 'error');
                    }
                } catch (err) {
                    console.error('启动扫码器时出错:', err);
                    showMessage(verificationMessage, '扫码功能启动失败，请刷新页面重试', 'error');
                    scannerActive = false;
                }
            }
            
            // 停止扫描功能
            function stopScanner() {
                try {
                    // 停止视频流
                    if (scanStream) {
                        try {
                            scanStream.getTracks().forEach(track => {
                                if (track && typeof track.stop === 'function') {
                                    track.stop();
                                }
                            });
                        } catch (stopErr) {
                            console.error('停止视频流时出错:', stopErr);
                        }
                        scanStream = null;
                    }
                    
                    // 清除扫描间隔
                    if (scanInterval) {
                        clearInterval(scanInterval);
                        scanInterval = null;
                    }
                    
                    // 更新UI
                    const video = document.getElementById('qr-video');
                    const instruction = document.getElementById('scan-instruction');
                    const startScanBtn = document.getElementById('start-scan-btn');
                    
                    if (video) video.style.display = 'none';
                    if (instruction) instruction.style.display = 'block';
                    
                    // 更新按钮
                    if (startScanBtn) {
                        startScanBtn.textContent = '开始扫码';
                        startScanBtn.classList.remove('btn-danger');
                        startScanBtn.classList.add('btn-success');
                    }
                    
                    // 重置状态
                    scannerActive = false;
                    showMessage(verificationMessage, '扫码器已停止', 'info');
                    
                } catch (err) {
                    console.error('停止扫码器时出错:', err);
                    // 强制重置状态
                    scannerActive = false;
                    scanStream = null;
                    scanInterval = null;
                }
            }
        }
        
        // 生成凭证功能
        function setupCredentialIssuance() {
            document.getElementById('issue-btn').addEventListener('click', async function() {
                const employeeName = document.getElementById('employee-name').value.trim();
                const jobTitle = document.getElementById('job-title').value.trim();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                // 表单验证
                if (!employeeName || !jobTitle || !startDate) {
                    showMessage(issueMessage, '请填写必填字段', 'error');
                    return;
                }
                
                try {
                    const result = await apiRequest('/api/credentials', 'POST', {
                        employeeName,
                        jobTitle,
                        startDate,
                        endDate
                    });
                    
                    if (result.success) {
                        // 显示成功模态框
                        const successModal = document.getElementById('success-modal');
                        const successMessage = document.getElementById('success-message');
                        const successQrCode = document.getElementById('success-qr-code');
                        
                        successMessage.textContent = `验证码：${result.verificationCode}`;
                        // 模拟二维码
                        successQrCode.innerHTML = `<div style="padding: 20px; background: white; border: 1px solid #ddd; display: inline-block;">二维码图片</div>`;
                        
                        successModal.style.display = 'flex';
                        
                        // 清空表单
                        document.getElementById('employee-name').value = '';
                        document.getElementById('job-title').value = '';
                        document.getElementById('start-date').value = '';
                        document.getElementById('end-date').value = '';
                        document.getElementById('description').value = '';
                        
                        // 更新仪表盘和凭证列表
                        loadDashboardData();
                        loadCredentials();
                    }
                } catch (error) {
                    console.error('生成凭证失败:', error);
                    showMessage(issueMessage, '生成凭证失败，请重试', 'error');
                }
            });
        }
        
        // 设置管理功能
        function setupSettings() {
            // 打开设置模态框
            document.getElementById('settings-btn').addEventListener('click', function() {
                loadSettings();
                loadVerificationSettings();
                settingsModal.style.display = 'flex';
            });
            
            // 关闭设置模态框
            document.getElementById('close-settings-btn').addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });
            
            // 点击模态框外部关闭
            settingsModal.addEventListener('click', function(event) {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });
            
            // 保存设置
            document.getElementById('save-settings-btn').addEventListener('click', async function() {
                const companyName = document.getElementById('company-name').value.trim();
                const companyWebsite = document.getElementById('company-website').value.trim();
                const contactEmail = document.getElementById('contact-email').value.trim();
                const maxVerifications = document.getElementById('max-verifications').value;
                const verificationWindow = document.getElementById('verification-window').value;
                const enableNotifications = document.getElementById('enable-notifications').checked;
                
                if (!companyName) {
                    showMessage(settingsMessage, '请输入公司名称', 'error');
                    return;
                }
                
                // 更新当前发行方信息
                currentIssuer = {
                    companyName,
                    companyWebsite,
                    contactEmail
                };
                
                // 保存验证设置到本地存储
                const verificationSettings = {
                    maxVerifications: maxVerifications || 5,
                    verificationWindow: verificationWindow || 30,
                    enableNotifications
                };
                localStorage.setItem('verificationSettings', JSON.stringify(verificationSettings));
                
                showMessage(settingsMessage, '设置保存成功', 'success');
                
                // 延迟关闭模态框
                setTimeout(() => {
                    settingsModal.style.display = 'none';
                }, 1000);
            });
        }
        
        // 成功模态框关闭
        function setupSuccessModal() {
            document.getElementById('success-close-btn').addEventListener('click', function() {
                document.getElementById('success-modal').style.display = 'none';
            });
        }
        
        // 凭证详情模态框关闭
        function setupDetailModal() {
            document.getElementById('detail-close-btn').addEventListener('click', function() {
                document.getElementById('credential-detail-modal').style.display = 'none';
            });
            
            // 点击模态框外部关闭
            document.getElementById('credential-detail-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    this.style.display = 'none';
                }
            });
        }
        
        // 初始化所有功能
        function initializeApp() {
            setupTabNavigation();
            setupLogout();
            setupCredentialSearch();
            setupCredentialIssuance();
            setupCredentialVerification();
            setupQRScanner();
            setupSettings();
            setupSuccessModal();
            setupDetailModal();
            
            // 加载初始数据
            loadDashboardData();
            loadCredentials();
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>